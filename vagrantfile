# -*- mode: ruby -*-
# vi: set ft=ruby :

IMAGE_NAME = "generic/ubuntu2004"
DEFAULT_CPU = 2
DEFAULT_MEMORY = 2048
IP_BASE =  "192.168.56."

MASTER_NAME = ENV['MASTER_NAME'] || "master"

WORKER_NAME_PREFIX = ENV['WORKER_NAME_PREFIX'] || "worker"
WORKER_NUM = (ENV['WORKER_NUM'] || 3).to_i


Vagrant.configure("2") do |config|  
   # ------------------------------------------------------
   # --------------- Default configurations ---------------
   # ------------------------------------------------------
   config.vm.box = IMAGE_NAME
   config.vm.hostname = "master"
   config.env.enable # Enable vagrant-env(.env)
   config.vm.provider "virtualbox" do |vb|
      vb.cpus = DEFAULT_CPU
      vb.memory = DEFAULT_MEMORY
   end
   # set up docker-kube
   config.vm.provision "shell", path: "./install-docker-kube.sh"
   # Set up SSH
   config.vm.provision "shell", inline: <<-SHELL
      # username: root - pass: 123
      echo "root:123" | chpasswd
      sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
      systemctl reload sshd
   SHELL
      

   # ------------------------------------------------------
   # -------------------- Master VM ------------------
   # ------------------------------------------------------
   config.vm.define MASTER_NAME do |master|
      master.vm.network "private_network", ip: "#{IP_BASE}#{10}"
      master.vm.hostname = MASTER_NAME
      master.vm.synced_folder "pods", "/root/pods" # share pods folder
      master.vm.provider "virtualbox" do |vbox|
         vbox.name = MASTER_NAME
      end
   end


   # ------------------------------------------------------
   # -------------------- Worker VM ------------------
   # ------------------------------------------------------
   (1..WORKER_NUM).each do |i|
      vm_name = "#{WORKER_NAME_PREFIX}#{i}"
      
      config.vm.define vm_name do |worker|
         worker.vm.network "private_network", ip: "#{IP_BASE}#{i + 10}"
         worker.vm.hostname = vm_name
         worker.vm.provider "virtualbox" do |vbox|
         vbox.name = vm_name
         end      
      end
   end
end